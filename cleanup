#!/bin/bash

# Delete system email
rm /var/spool/mail/*

# Remove nano search history and such
rm -rf /root/.nano
rm -rf /home/*/.nano

# Remove ODROID resize log
rm -rf /root/resize--log.txt

sudo apt-get clean
sudo apt-get autoclean
apt-get autoremove

echo "Don't forget to remove the old kernels:"
dpkg --get-selections | grep linux-image

# Delete all Samba users
pdbedit -L | while read USER; do pdbedit -x -u $(echo $USER | cut -d: -f1); done

# Empty old logs
find /var/log/ -type f -exec cp /dev/null {} \;
find /var/log/ -iname "*.gz" -type f -delete
find /var/log/ -iname "*.log.*" -type f -delete
cat /dev/null > /var/log/wtmp
cat /dev/null > /var/log/btmp

# Clear system mail
find /var/mail/ -type f -exec cp /dev/null {} \;

rm /root/.nano_history
rm /root/.bash_history
rm /home/*/.nano_history
rm /home/*/.bash_history

# ROCK64
rm -rf /var/lib/rock64 # Ayufan's build places a file in that folder which stops it from resizing on boot

# PINE A64+
rm -rf /var/lib/pine64 # Ayufan's build places a file in that folder which stops it from resizing on boot

# remove any package data left behind after removal
apt -y purge $(dpkg -l | awk '/^rc/ { print $2 }')
 
rm /var/log/lastlog
touch /var/log/lastlog

# Remove DNS Resolver config (will be auto-generated on first boot)
echo "# Default resolv.conf file by Robbie Ferguson // BaldNerd.com
# Cloudflare
nameserver 1.1.1.1
nameserver 1.0.0.1
nameserver 2606:4700:4700::1111
nameserver 2606:4700:4700::1001
# Google
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 2001:4860:4860::8888
nameserver 2001:4860:4860::8844
" > /etc/resolv.conf


# Quick cheat to avoid errors if no files exist
touch /etc/update-motd.d/dummy

# Remove any MOTD items included with the base distro
rm /etc/update-motd.d/*

# Enable NEMS MOTD
echo '
****************************************************
Debian Base Image by Robbie Ferguson // BaldNerd.com
****************************************************

Become root user:    sudo su
Set timezone:        dpkg-reconfigure tzdata
Set locale:          dpkg-reconfigure locales
Check date and time: date
Set date and time:   See https://baldnerd.com/nerdgasms/linuxdate/

Appreciate what I do?
  - https://donate.category5.tv
  - https://patreon.com/nemslinux
' > /etc/motd

# Prepare filesystem resize on first boot
wget -O /usr/local/bin/nems-fs-resize https://raw.githubusercontent.com/Cat5TV/nems-admin/master/resize_rootfs/nems-fs-resize
chmod +x /usr/local/bin/nems-fs-resize
# Adapt script for Bald Nerd Base Image
/bin/sed -i -- 's,/root/nems/nems-admin/resize_rootfs/nems-fs-resize,/usr/local/bin/nems-fs-resize,g' /etc/rc.local
addition="/usr/local/bin/nems-fs-resize\n"
if ! grep -q "nems-fs-resize" /etc/rc.local; then
  if grep -q "exit" /etc/rc.local; then
    # This file contains an exit command, so make sure our new command comes before it
    /bin/sed -i -- 's,exit,'"$addition"'exit,g' /etc/rc.local
  else
    # No exit command within the file, so just add it
    echo "PLACEHERE" >> /etc/rc.local
    /bin/sed -i -- 's,PLACEHERE,'"$addition"'exit 0,g' /etc/rc.local
  fi
fi

# Write zeros to unused blocks before halting to create the img
echo "Filling empty space with zeros..."
dd if=/dev/zero bs=1M of=/root/.null && sync
while [ -f /root/.null ]
do
  sync
  rm -f /root/.null
  sync
  sleep 5
done

echo "Done. Halting."
sync
halt
